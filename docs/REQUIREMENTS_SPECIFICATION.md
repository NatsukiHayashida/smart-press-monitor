# プレス機管理システム リニューアル要件定義書

## 📋 プロジェクト概要

### プロジェクト名
Smart Press Monitor v2.0 - Clerkベース認証・モダンUIリニューアル

### 目的
1. **認証システムの刷新**: Supabase AuthからClerkへの移行により、ユーザビリティとセキュリティを向上
2. **UIデザインの刷新**: Appleライクなモダンデザインシステムの導入
3. **技術スタックの最新化**: Tailwind CSS v4、最新認証フローの採用
4. **データ保持**: 既存のプレス機データと組織構造を完全に保持

### 対象システム
- **現行**: Next.js 15 + Supabase Auth + Tailwind CSS v3
- **リニューアル後**: Next.js 15 + Clerk Auth + Tailwind CSS v4 + 新デザインシステム

## 🔍 現状分析

### 現在のシステム機能

#### 認証・ユーザー管理
- ✅ Supabaseマジックリンク認証（メールベース）
- ✅ マルチテナント対応（組織単位でのデータ分離）
- ✅ プロフィール管理
- ✅ RLS（Row Level Security）によるデータアクセス制御

#### 主要機能
1. **ダッシュボード**
   - プレス機総台数表示
   - 種別・生産グループ別集計
   - 最近のメンテナンス記録表示
   - 統計カード表示

2. **プレス機管理**
   - プレス機一覧表示
   - 新規プレス機登録
   - プレス機詳細表示・編集
   - 機械番号・設備番号・メーカー等の管理

3. **メンテナンス管理**
   - メンテナンス記録一覧
   - 新規メンテナンス記録作成
   - メンテナンス記録編集
   - 総合判定・弁交換記録管理

4. **統計・分析**
   - 基本統計表示
   - レポート機能

#### データ構造
```sql
- orgs: 組織管理
- profiles: ユーザープロフィール
- press_machines: プレス機情報
- maintenance_records: メンテナンス記録
```

### 現在の課題

#### 認証システム
- ❌ ログイン手順が複雑（メール確認必須）
- ❌ パスワード管理の不便さ
- ❌ ソーシャルログイン未対応
- ❌ 認証フローの自由度不足

#### UI/UX
- ❌ 古いデザインシステム
- ❌ アクセシビリティ対応不足
- ❌ レスポンシブデザインの改善余地
- ❌ 一貫性のないユーザーエクスペリエンス

## ✨ リニューアル要件

### 機能要件

#### 1. 認証システム（Clerk導入）

**必須要件**
- ✅ メール・パスワード認証
- ✅ Googleアカウント連携
- ✅ GitHubアカウント連携
- ✅ マジックリンク認証（オプション）
- ✅ 2要素認証対応
- ✅ パスワードリセット機能

**データ移行要件**
- ✅ 既存ユーザーデータの完全保持
- ✅ 組織・ユーザー関係の維持
- ✅ プレス機データの完全保持
- ✅ メンテナンス履歴の完全保持

**セキュリティ要件**
- ✅ ClerkとSupabase RLSの統合
- ✅ カスタムヘッダー方式によるRLS実装
- ✅ 組織レベルのデータ分離維持
- ✅ API保護の強化

#### 2. デザインシステム刷新

**デザイン原則**
- ✅ Apple Human Interface Guidelines準拠
- ✅ アクセシビリティ最優先（WCAG 2.1 AA準拠）
- ✅ レスポンシブファーストデザイン
- ✅ 一貫性のあるユーザーエクスペリエンス

**カラーシステム**
```css
/* プライマリカラー */
- メインブルー: blue-500 (#3B82F6)
- ダークブルー: blue-600 (#2563EB)
- 強調ブルー: blue-700 (#1D4ED8)

/* グレースケール */
- テキストメイン: gray-900 (#111827)
- テキストサブ: gray-700 (#374151)
- 境界線: gray-300 (#D1D5DB)
- 背景: white (#FFFFFF)
```

**コンポーネント仕様**
- ✅ 統一された角丸システム
- ✅ 一貫したスペーシング
- ✅ アニメーション・マイクロインタラクション
- ✅ アクセシブルなフォーカス状態

#### 3. 技術スタック更新

**フロントエンド**
- ✅ Tailwind CSS v4（ゼロコンフィグレーション）
- ✅ shadcn/ui v2対応
- ✅ React Hook Form + Zod（継続）
- ✅ TypeScript強化

**認証・バックエンド**
- ✅ Clerk認証システム
- ✅ Supabase（データベース・リアルタイム）
- ✅ カスタムヘッダー方式でのRLS統合

### 非機能要件

#### パフォーマンス
- ⚡ ページ読み込み時間: 3秒以内
- ⚡ First Contentful Paint: 1.5秒以内
- ⚡ Cumulative Layout Shift: 0.1以下

#### アクセシビリティ
- ♿ WCAG 2.1 AA準拠
- ♿ キーボードナビゲーション完全対応
- ♿ スクリーンリーダー対応
- ♿ カラーコントラスト比: 4.5:1以上

#### セキュリティ
- 🔒 認証トークンの安全な管理
- 🔒 CSRF攻撃防止
- 🔒 XSS攻撃防止
- 🔒 データ暗号化（保存時・転送時）

#### 可用性
- 📈 稼働率: 99.9%以上
- 📈 データバックアップ: 日次自動実行
- 📈 障害復旧時間: 4時間以内

## 🎯 機能詳細仕様

### 1. 認証フロー

#### ログイン画面
```typescript
interface LoginOptions {
  email: string;
  password: string;
  rememberMe: boolean;
  socialProviders: ['google', 'github'];
  magicLink: boolean;
}
```

#### サインアップ画面
```typescript
interface SignupFlow {
  emailVerification: boolean;
  organizationInvite: boolean;
  profileSetup: boolean;
  welcomeMessage: boolean;
}
```

### 2. ダッシュボード刷新

#### レイアウト仕様
- ✅ グリッドベースのレスポンシブレイアウト
- ✅ カード型コンポーネントの統一
- ✅ データ可視化の改善
- ✅ リアルタイム更新対応

#### 統計表示
```typescript
interface DashboardMetrics {
  totalMachines: number;
  machinesByType: Record<string, number>;
  machinesByGroup: Record<string, number>;
  maintenanceStats: {
    total: number;
    thisMonth: number;
    pendingIssues: number;
  };
  recentActivity: MaintenanceRecord[];
}
```

### 3. プレス機管理

#### 一覧画面仕様
- ✅ テーブル形式での一覧表示
- ✅ ソート・フィルタリング機能
- ✅ ページネーション
- ✅ 検索機能（機械番号・メーカー等）
- ✅ バルクアクション対応

#### 詳細・編集画面仕様
- ✅ タブ形式での情報整理
- ✅ フォームバリデーション強化
- ✅ 画像アップロード対応（将来拡張）
- ✅ 履歴表示機能

### 4. メンテナンス管理

#### 記録作成・編集
- ✅ ステップ形式の入力フロー
- ✅ 日付・時刻ピッカーの改善
- ✅ 判定基準のガイド表示
- ✅ 写真添付機能（将来拡張）

## 📊 データマイグレーション計画

### Phase 1: 認証データの準備
```sql
-- Clerk User ID とSupabaseユーザーの紐付けテーブル
CREATE TABLE user_migrations (
  supabase_user_id UUID REFERENCES auth.users(id),
  clerk_user_id TEXT NOT NULL,
  migration_date TIMESTAMPTZ DEFAULT NOW(),
  status TEXT DEFAULT 'pending'
);
```

### Phase 2: RLS ポリシー更新
```sql
-- カスタムヘッダー対応のRLSポリシー
CREATE POLICY "press_machines_clerk_access" ON press_machines
  FOR ALL USING (
    org_id = (current_setting('app.current_org_id', true))::UUID
  );
```

### Phase 3: データ整合性確認
- ✅ 全プレス機データの整合性チェック
- ✅ メンテナンス記録の関連性確認
- ✅ 組織・ユーザー関係の検証

## 🚀 成功指標

### ユーザビリティ
- 📈 ログイン完了時間: 50%短縮
- 📈 新規ユーザー登録完了率: 80%以上
- 📈 ユーザー満足度: 8/10以上

### パフォーマンス
- ⚡ ページ読み込み速度: 40%向上
- ⚡ Core Web Vitals: すべて良好
- ⚡ バンドルサイズ: 20%削減

### セキュリティ
- 🔒 セキュリティインシデント: 0件
- 🔒 不正アクセス試行の検知・ブロック: 100%
- 🔒 データ漏洩: 0件

## 🎨 UI/UXプロトタイプ

### キーページのワイヤーフレーム

#### ログイン画面
```
┌─────────────────────────────────────┐
│  Smart Press Monitor v2.0           │
├─────────────────────────────────────┤
│                                     │
│     [Logo]                          │
│                                     │
│     メールアドレス                    │
│     [________________]              │
│                                     │
│     パスワード                       │
│     [________________]              │
│                                     │
│     [ログイン] [Googleでログイン]     │
│                                     │
│     パスワードを忘れた方              │
│     アカウントをお持ちでない方        │
│                                     │
└─────────────────────────────────────┘
```

#### ダッシュボード
```
┌─────────────────────────────────────┐
│  Header + Navigation                │
├─────────────────────────────────────┤
│                                     │
│  ダッシュボード                      │
│                                     │
│  [プレス機統計]  [メンテナンス統計]   │
│                                     │
│  [種別別集計]    [グループ別集計]     │
│                                     │
│  [最近のメンテナンス記録一覧]         │
│                                     │
└─────────────────────────────────────┘
```

## 📝 受け入れ基準

### 認証システム
- [ ] Clerkによる複数認証方式の実装
- [ ] 既存ユーザーデータの完全移行
- [ ] RLS統合の正常動作
- [ ] セキュリティテストのパス

### デザインシステム
- [ ] 全ページでの新デザイン適用
- [ ] アクセシビリティ基準の達成
- [ ] レスポンシブデザインの確認
- [ ] ブラウザ互換性テスト

### データ保持
- [ ] 既存プレス機データの完全保持
- [ ] メンテナンス履歴の完全保持
- [ ] 組織・ユーザー関係の維持
- [ ] データ整合性の確認

### パフォーマンス
- [ ] Core Web Vitals基準の達成
- [ ] ページ読み込み時間の改善
- [ ] バンドルサイズの最適化
- [ ] メモリ使用量の最適化

---

**文書作成日**: 2024年9月16日  
**最終更新日**: 2024年9月16日  
**承認者**: システム管理者  
**次回レビュー予定**: 実装開始前